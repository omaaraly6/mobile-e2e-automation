name: Maestro Android E2E

on:
  workflow_dispatch:

jobs:
  android-e2e:
    runs-on: macos-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17
      
      - name: Install Homebrew
        run: |
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
      - name: Install Maestro CLI
        run: |
              brew tap mobile-dev-inc/tap
              brew install maestro

      - name: Download Android Emulator Image
        run: |
          sdkmanager --install "system-images;android-31;google_apis;arm64-v8a"

      - name: Create Android Emulator
        run: |
          echo "no" | avdmanager create avd -n pixel7 -k "system-images;android-31;google_apis;arm64-v8a" -d pixel_5

      - name: Start Android Emulator
        run: |
          nohup emulator -avd pixel7 -no-window -no-audio -no-boot-anim -gpu swiftshader_indirect &

      - name: Wait for Android Emulator to Boot
        run: |
          echo "Waiting for emulator to boot..."
          adb wait-for-device
          boot_completed=""
          while [[ "$boot_completed" != "1" ]]; do
            sleep 5
            boot_completed=$(adb shell getprop sys.boot_completed | tr -d '\r')
            echo "Boot completed: $boot_completed"
          done
          adb shell input keyevent 82  # unlock screen
          echo "Emulator is ready!"

          
      - name: Download Android APK
        run: |
            curl -L -o ChallazTopfade.apk "https://expo.dev/artifacts/eas/your-artifact-id.apk"
        
      - name: Install APK on Emulator
        run: |
            adb install ChallazTopfade.apk
        
      - name: Run Maestro flow
        run: |
            maestro test maestro/